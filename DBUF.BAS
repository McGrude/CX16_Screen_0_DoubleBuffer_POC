10 REM =========================================
20 REM  DOUBLE BUFFER DEMO - SCREEN 0 / LAYER 1
30 REM  USES DEFAULT SCREEN + VRAM $4000
40 REM =========================================
50 SCREEN 0

60 MR = 40757         : REM $9F35  = LAYER 1 MAPBASE REGISTER
70 FB = 216           : REM FRONT: DEFAULT SCREEN AT VRAM $1B000
80 BB = 32            : REM BACK: VRAM $4000 (32*512 = $4000)

100 REM PRE-COMPUTED CONSTANTS
110 MW = 128          : REM FULL MAP WIDTH (TILES)
120 VW = 80           : REM VISIBLE WIDTH (SCREEN 0)
130 VH = 60           : REM VISIBLE HEIGHT
140 RB = MW*2         : REM 2 BYTES PER TILE -> 256 BYTES/ROW
150 CF = 1            : REM WHITE FG COLOR
160 CB = 6            : REM BLUE BG COLOR
165 YL = 7            : REM YELLOW FG FOR BAR
170 AT = CF+CB*16     : REM FG + BG*16
175 BT = YL+CB*16     : REM YELLOW FG + BLUE BG*16

180 REM INITIALIZE BOTH BUFFERS WITH STATIC CONTENT
190 GOSUB 5000

200 REM INITIAL ANIMATION STATE
210 X = 0             : REM BOX X POSITION
220 Y = 25            : REM BOX Y POSITION
230 DX = 1            : REM BOX X DIRECTION
240 DY = 1            : REM BOX Y DIRECTION
250 FR = 0            : REM FRAME COUNTER

280 REM BOX DIMENSIONS
290 BW = 10           : REM BOX WIDTH
300 BH = 10           : REM BOX HEIGHT

310 REM ===============================
320 REM  MAIN LOOP
330 REM ===============================
340 FR = FR + 1

350 REM SAVE CURRENT POSITION BEFORE UPDATING
360 PX = X
370 PY = Y

380 REM UPDATE BOX POSITION
390 X = X + DX
400 Y = Y + DY
410 IF X > 70 THEN X = 70 : DX = -1
420 IF X < 0 THEN X = 0 : DX = 1
430 IF Y > 48 THEN Y = 48 : DY = -1
440 IF Y < 2 THEN Y = 2 : DY = 1

450 REM DRAW INTO BOTH BUFFERS TO KEEP THEM IN SYNC
460 GOSUB 3000        : REM DRAW INTO BACK BUFFER
470 GOSUB 3500        : REM SWAP BUFFERS
480 GOSUB 3000        : REM DRAW INTO NEW BACK BUFFER
490 GOSUB 3500        : REM SWAP BACK

500 REM ADD DELAY FOR VISIBLE ANIMATION
510 FOR DL = 1 TO 50 : NEXT DL

520 GOTO 340


1999 REM =========================================
2000 REM  CALC VRAM BANK AND ADDR FROM BB
2010 REM  INPUT: BB (MAPBASE VALUE)
2020 REM  OUTPUT: BK (BANK), BA (BASE ADDRESS)
2030 REM =========================================
2040 IF BB = 32 THEN BK = 0 : BA = 16384 : RETURN
2050 IF BB = 216 THEN BK = 1 : BA = 45056 : RETURN
2060 RETURN


2999 REM =========================================
3000 REM  UPDATE ONLY CHANGED PARTS OF BACK BUFFER
3010 REM  - ERASE OLD BOX POSITION (FROM PX,PY)
3020 REM  - UPDATE FRAME COUNTER
3030 REM  - DRAW NEW BOX POSITION (AT X,Y)
3040 REM =========================================
3050 GOSUB 2000        : REM BK,BA = BACK BUFFER FROM BB

3060 REM ERASE OLD BOX POSITION (DRAW SPACES)
3070 FOR YY = 0 TO BH-1
3080   RW = BA + (PY+YY)*RB
3090   FOR XX = 0 TO BW-1
3100     A = RW + (PX+XX)*2
3110     VPOKE BK,A,32       : REM SPACE
3120     VPOKE BK,A+1,AT     : REM NORMAL COLORS
3130   NEXT XX
3140 NEXT YY

3150 REM UPDATE FRAME COUNTER ON SECOND ROW
3160 S$ = "FRAME: " + STR$(FR)
3170 TL = LEN(S$)
3180 RW = BA + 1*RB
3190 FOR I = 0 TO TL-1
3200   A = RW + I*2
3210   C = ASC(MID$(S$,I+1,1))
3220   IF C >= 65 AND C <= 90 THEN C = C - 64
3230   VPOKE BK,A,C
3240   VPOKE BK,A+1,AT
3250 NEXT I

3260 REM DRAW NEW BOX POSITION
3270 FOR YY = 0 TO BH-1
3280   RW = BA + (Y+YY)*RB
3290   FOR XX = 0 TO BW-1
3300     A = RW + (X+XX)*2
3310     VPOKE BK,A,230      : REM CHECKERBOARD CHARACTER
3320     VPOKE BK,A+1,BT     : REM YELLOW ON BLUE
3330   NEXT XX
3340 NEXT YY

3350 RETURN


3499 REM =========================================
3500 REM  SWAP FRONT/BACK BUFFERS
3510 REM =========================================
3520 T = FB : FB = BB : BB = T
3530 POKE MR,FB
3540 RETURN


4999 REM =========================================
5000 REM  INITIALIZE BOTH BUFFERS WITH STATIC CONTENT
5010 REM  (TITLE AND BLUE BACKGROUND)
5020 REM =========================================
5030 REM INITIALIZE BACK BUFFER (NOT VISIBLE)
5040 GOSUB 5100
5050 REM INITIALIZE FRONT BUFFER (VISIBLE)
5060 T = FB : FB = BB : BB = T
5070 GOSUB 5100
5080 T = FB : FB = BB : BB = T
5090 RETURN

5099 REM =========================================
5100 REM  DRAW STATIC CONTENT TO CURRENT BB
5110 REM =========================================
5120 GOSUB 2000        : REM BK,BA = BUFFER FROM BB

5130 REM CLEAR ENTIRE BUFFER TO BLUE
5140 FOR R = 0 TO VH-1
5150   RW = BA + R*RB
5160   FOR CX = 0 TO VW-1
5170     A = RW + CX*2
5180     VPOKE BK,A,32
5190     VPOKE BK,A+1,AT
5200   NEXT CX
5210 NEXT R

5220 REM WRITE TITLE ON FIRST ROW
5230 TS$ = "DOUBLE BUFFER DEMO"
5240 TL = LEN(TS$)
5250 RW = BA + 0*RB
5260 SX = INT((VW-TL)/2)
5270 FOR I = 0 TO TL-1
5280   A = RW + (SX+I)*2
5290   C = ASC(MID$(TS$,I+1,1))
5300   IF C >= 65 AND C <= 90 THEN C = C - 64
5310   VPOKE BK,A,C
5320   VPOKE BK,A+1,AT
5330 NEXT I

5340 RETURN