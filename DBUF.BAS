10 REM =========================================
20 REM  DOUBLE BUFFER DEMO - SCREEN 0 / LAYER 1
30 REM  - USES LAYER 1 TEXT MODE (SCREEN 0)
40 REM  - FRONT BUFFER = DEFAULT TEXT MAP AT VRAM $1B000
50 REM  - BACK  BUFFER = SECOND TEXT MAP AT VRAM $4000
60 REM  - ANIMATES A BOX USING DOUBLE-BUFFERED TILEMAPS
70 REM =========================================

80 SCREEN 0           : REM ENSURE 80X60 TEXT MODE ON LAYER 1

90 REM =========================================
100 REM  GLOBAL CONSTANTS AND VARIABLES
110 REM =========================================
120 MR = 40757        : REM L1_MAPBASE REGISTER ($9F35) - CONTROLS LAYER 1 TILEMAP BASE
130 FB = 216          : REM FRONT BUFFER MAPBASE (216*512 = $1B000 DEFAULT TEXT MAP)
140 BB = 32           : REM BACK  BUFFER MAPBASE ( 32*512 = $04000 SECOND MAP)

150 MW = 128          : REM FULL TILEMAP WIDTH (TILES) IN VRAM (128X64 TILEMAP)
160 VW = 80           : REM VISIBLE TEXT WIDTH (COLUMNS)  FOR SCREEN 0
170 VH = 60           : REM VISIBLE TEXT HEIGHT (ROWS)    FOR SCREEN 0
180 RB = MW*2         : REM BYTES PER TILEMAP ROW (2 BYTES/TILE: CHAR + COLOR) => 256

190 CF = 1            : REM FOREGROUND COLOR: WHITE
200 CB = 6            : REM BACKGROUND COLOR: BLUE
210 YL = 7            : REM YELLOW FG COLOR FOR ANIMATED BOX

220 AT = CF + CB*16   : REM NORMAL TEXT COLOR NYBBLE (FG + BG*16)
230 BT = YL + CB*16   : REM BOX COLOR (YELLOW FG + BLUE BG*16)

240 REM ANIMATION STATE VARIABLES
250 X  = 0            : REM CURRENT BOX X POSITION (COLUMN, LEFT EDGE)
260 Y  = 25           : REM CURRENT BOX Y POSITION (ROW, TOP EDGE)
270 DX = 1            : REM BOX X DIRECTION (+1 OR -1)
280 DY = 1            : REM BOX Y DIRECTION (+1 OR -1)
290 FR = 0            : REM FRAME COUNTER (INCREMENTS EACH LOOP)

300 REM PREVIOUS BOX POSITION (USED TO ERASE OLD BOX)
310 PX = X            : REM PREVIOUS BOX X POSITION
320 PY = Y            : REM PREVIOUS BOX Y POSITION

330 REM BOX SIZE (IN TILES/CHARACTERS)
340 BW = 10           : REM BOX WIDTH  (COLUMNS)
350 BH = 10           : REM BOX HEIGHT (ROWS)

360 REM WORK VARIABLES FOR VRAM ACCESS
370 BK = 0            : REM CURRENT VRAM BANK (0 OR 1) FOR ACTIVE BUFFER
380 BA = 0            : REM CURRENT BASE ADDRESS (WITHIN BANK) FOR TILEMAP
390 RW = 0            : REM TEMP: START ADDRESS OF A TILEMAP ROW
400 A  = 0            : REM TEMP: ADDRESS OF A CHARACTER CELL

410 REM STRING BUFFERS
420 TS$ = ""          : REM TITLE STRING ("DOUBLE BUFFER DEMO")
430 S$  = ""          : REM FRAME COUNTER STRING ("FRAME: ###")

440 REM LOOP INDEXES
450 YY = 0           : REM INNER LOOP: BOX ROW INDEX
460 XX = 0           : REM INNER LOOP: BOX COLUMN INDEX
470 I  = 0           : REM GENERAL LOOP INDEX
480 R  = 0           : REM ROW INDEX FOR CLEARING FULL BUFFER
490 CX = 0           : REM COLUMN INDEX FOR CLEARING FULL BUFFER

500 REM =========================================
510 REM  INITIALIZE BOTH TILEMAP BUFFERS
520 REM =========================================
530 GOSUB 5000       : REM DRAW STATIC BACKGROUND (TITLE, BLUE FILL) INTO BOTH BUFFERS

540 REM =========================================
550 REM  MAIN ANIMATION LOOP
560 REM =========================================
570 REM LOOP START
580 FR = FR + 1      : REM INCREMENT FRAME COUNTER

590 REM SAVE OLD POSITION BEFORE UPDATING
600 PX = X
610 PY = Y

620 REM UPDATE BOX POSITION WITH BOUNCING LIMITS
630 X = X + DX
640 Y = Y + DY

650 REM CLAMP X TO [0..70] SO BOX FITS IN 80 COLUMNS (BW=10)
660 IF X > 70 THEN X = 70 : DX = -1
670 IF X < 0  THEN X = 0  : DX = 1

680 REM CLAMP Y TO [2..48] SO BOX STAYS AWAY FROM TITLE/FRAME ROWS
690 IF Y > 48 THEN Y = 48 : DY = -1
700 IF Y < 2  THEN Y = 2  : DY = 1

710 REM DRAW NEXT FRAME INTO BACK BUFFER AND KEEP BOTH BUFFERS IN SYNC
720 GOSUB 3000       : REM DRAW NEW FRAME INTO CURRENT BACK BUFFER
730 GOSUB 3500       : REM SWAP FRONT/BACK (NEW FRAME BECOMES VISIBLE)
740 GOSUB 3000       : REM DRAW SAME FRAME INTO OTHER BUFFER (NOW BACK)
750 GOSUB 3500       : REM SWAP AGAIN (RESTORE ORIGINAL FRONT/BACK ROLES)

760 REM CONTINUE ANIMATION FOREVER
770 GOTO 580


1990 REM =========================================
2000 REM  MAPBASE -> (BK,BA) FOR CURRENT BACK BUFFER
2010 REM  INPUT : BB (MAPBASE VALUE FOR BACK BUFFER)
2020 REM  OUTPUT: BK (VRAM BANK 0/1), BA (BASE ADDRESS WITHIN BANK)
2030 REM  NOTE  : VRAM ADDRESS = MAPBASE * 512
2040 REM =========================================
2050 AD = BB * 512
2060 IF AD >= 65536 THEN BK = 1 : BA = AD - 65536 : RETURN
2070 BK = 0 : BA = AD
2080 RETURN


2990 REM =========================================
3000 REM  DRAW ONE FRAME INTO CURRENT BACK BUFFER
3010 REM  - ERASE BOX AT PREVIOUS POSITION (PX,PY)
3020 REM  - UPDATE FRAME COUNTER TEXT ON ROW 1
3030 REM  - DRAW BOX AT NEW POSITION (X,Y)
3040 REM  BACK BUFFER IS ALWAYS DETERMINED BY BB
3050 REM =========================================
3060 GOSUB 2000       : REM SET BK,BA FOR CURRENT BACK BUFFER USING BB

3070 REM =========================================
3080 REM ERASE OLD BOX (DRAW SPACES WHERE BOX USED TO BE)
3090 REM =========================================
3100 FOR YY = 0 TO BH-1
3110   RW = BA + (PY+YY)*RB         : REM START ADDRESS OF ROW (PY+YY)
3120   FOR XX = 0 TO BW-1
3130     A = RW + (PX+XX)*2         : REM ADDRESS OF TILE (CHAR BYTE)
3140     VPOKE BK,A,32              : REM WRITE SPACE CHARACTER
3150     VPOKE BK,A+1,AT            : REM RESTORE NORMAL FG/BG COLOR
3160   NEXT XX
3170 NEXT YY

3180 REM =========================================
3190 REM UPDATE FRAME COUNTER TEXT ON SECOND ROW (ROW 1)
3200 REM FORMAT: "FRAME: NNNN"
3210 REM =========================================
3220 S$ = "FRAME: " + STR$(FR)
3230 RW = BA + 1*RB                 : REM SECOND ROW (ROW 1) BASE ADDRESS

3240 REM CLEAR FIRST 16 CELLS ON FRAME ROW TO AVOID LEFTOVER DIGITS
3250 FOR I = 0 TO 15
3260   A = RW + I*2
3270   VPOKE BK,A,32
3280   VPOKE BK,A+1,AT
3290 NEXT I

3300 REM WRITE FRAME STRING IN PETSCII SCREEN CODES
3310 TL = LEN(S$)
3320 FOR I = 0 TO TL-1
3330   A = RW + I*2
3340   C = ASC(MID$(S$,I+1,1))      : REM ASCII CHAR
3350   IF C >= 65 AND C <= 90 THEN C = C - 64
3360   REM ABOVE: MAP ASCII 'A'-'Z' (65-90) TO SCREEN CODES 1-26
3370   VPOKE BK,A,C
3380   VPOKE BK,A+1,AT
3390 NEXT I

3400 REM =========================================
3410 REM DRAW BOX AT NEW POSITION (X,Y) USING CHAR 230
3420 REM =========================================
3430 FOR YY = 0 TO BH-1
3440   RW = BA + (Y+YY)*RB          : REM START ADDRESS OF ROW (Y+YY)
3450   FOR XX = 0 TO BW-1
3460     A = RW + (X+XX)*2
3470     VPOKE BK,A,230             : REM CHECKERBOARD OR BLOCK CHAR
3480     VPOKE BK,A+1,BT            : REM YELLOW ON BLUE
3490   NEXT XX
3500 NEXT YY

3510 RETURN


3490 REM =========================================
3500 REM  SWAP FRONT AND BACK BUFFERS
3510 REM  - EXCHANGE FB AND BB MAPBASE VALUES
3520 REM  - UPDATE L1_MAPBASE REGISTER TO SHOW NEW FRONT
3530 REM =========================================
3540 T = FB : FB = BB : BB = T
3550 POKE MR,FB
3560 RETURN


4990 REM =========================================
5000 REM  INITIALIZE BOTH BUFFERS WITH STATIC CONTENT
5010 REM  - BLUE BACKGROUND
5020 REM  - CENTERED TITLE ON ROW 0
5030 REM  RESULT: FRONT AND BACK BUFFERS CONTAIN IDENTICAL CONTENT
5040 REM =========================================
5050 REM FIRST: INITIALIZE WHICHEVER BUFFER BB CURRENTLY POINTS TO
5060 GOSUB 5100

5070 REM SECOND: SWAP BUFFERS, INIT OTHER ONE, SWAP BACK
5080 T = FB : FB = BB : BB = T
5090 GOSUB 5100
5100 T = FB : FB = BB : BB = T

5110 RETURN


5090 REM =========================================
5100 REM  DRAW STATIC BACKGROUND INTO CURRENT BACK BUFFER (BB)
5110 REM  - BLUE FILL
5120 REM  - TITLE "DOUBLE BUFFER DEMO" ON TOP ROW (ROW 0)
5130 REM  USES BB TO FIND TILEMAP IN VRAM
5140 REM =========================================
5150 GOSUB 2000                         : REM SET BK,BA FOR CURRENT BB

5160 REM CLEAR VISIBLE AREA (80X60) TO BLUE BACKGROUND WITH SPACES
5170 FOR R = 0 TO VH-1
5180   RW = BA + R*RB                   : REM START ADDRESS OF ROW R
5190   FOR CX = 0 TO VW-1
5200     A = RW + CX*2
5210     VPOKE BK,A,32                  : REM SPACE CHARACTER
5220     VPOKE BK,A+1,AT                : REM NORMAL FG/BG COLORS
5230   NEXT CX
5240 NEXT R

5250 REM WRITE CENTERED TITLE ON FIRST ROW (ROW 0)
5260 TS$ = "DOUBLE BUFFER DEMO"
5270 TL = LEN(TS$)
5280 RW = BA + 0*RB                     : REM TOP ROW BASE ADDRESS
5290 SX = INT((VW - TL) / 2)           : REM START X SO TITLE IS CENTERED

5300 FOR I = 0 TO TL-1
5310   A = RW + (SX+I)*2
5320   C = ASC(MID$(TS$,I+1,1))        : REM ASCII CHARACTER
5330   IF C >= 65 AND C <= 90 THEN C = C - 64
5340   REM MAP ASCII 'A'-'Z' TO SCREEN CODES 1-26
5350   VPOKE BK,A,C
5360   VPOKE BK,A+1,AT
5370 NEXT I

5380 RETURN

